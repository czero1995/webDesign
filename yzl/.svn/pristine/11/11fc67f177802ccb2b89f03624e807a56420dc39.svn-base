{extend name="layout/base"}

{block name="title"}
<title>教练列表</title>
{/block}

{block name="style"}
<style type="text/css">
    .swiper-container {
        overflow: auto;
    !important;
    }
</style>
{/block}

{block name="content"}
<div class="page coach-page">
    <div class="page-content infinite-scroll">
        <!--轮播-->
        <div class="swiper-container swiper-stadium">
            <div class="swiper-wrapper">
                <div class="swiper-slide" v-for="banner in banners">
                    <img :src="banner.post"/></div>
            </div>
            <div class="swiper-pagination"></div>
        </div>
        <!--选择栏-->
        <div class="lesson-tabbar">
            <div class="tabbar-item" @click="onSelect('coachRecommend')">
                <img src="__STATIC__/wx/img/btn_recommend_sel@2x.png" class="item-recommend-img"
                     v-bind:class="{ active: selected === 'coachRecommend'}"/>
                <div class="tabbar-text tabbartext-select tabbartext-recommend">推荐</div>
            </div>
            <div class="tabbar-item" @click="onSelect('coachHot')">
                <img src="__STATIC__/wx/img/btn_Popularity_nor@2x.png" class="item-hot-img"
                     v-bind:class="{ active: selected === 'coachHot'}"/>
                <div class="tabbar-text tabbartext-hot">人气</div>
            </div>
            <div class="tabbar-item" @click="onSelect('coachFilter')">
                <img src="__STATIC__/wx/img/btn_filter_nor@2x.png" class="item-filter-img"
                     v-bind:class="{ active: selected === 'coachFilter'}"/>
                <div class="tabbar-text tabbartext-filter">筛选</div>
            </div>
        </div>
        <!--推荐-->
        <div class="coach-recommend" v-show="selected === 'coachRecommend'">
            <div class="coach-item clearfloat" v-for="itemCoach in coachLists">
                <a :href="itemCoach.url" class="external">
                    <img :src="itemCoach.headimg" class="coach-img"/>
                    <div class="coach-info clearfloat">
                        <span class="title-name">{{itemCoach.name}}</span>
                        <img src="__STATIC__/wx/img/ic_gender_man@2x.png" class="coach-sex-img"
                             v-show="1 == itemCoach.sex"/>
                        <img src="__STATIC__/wx/img/ic_gender_women@2x.png" class="coach-sex-img"
                             v-show="2 == itemCoach.sex"/>
                        <p class="coach-introduce">{{itemCoach.intro}}</p>
                        <div class="coach-label" v-for="name in itemCoach.tags_name">
                            <div class="label-item">{{name.name}}</div>
                        </div>
                    </div>
                </a>
            </div>
        </div>
        <!--人气-->
        <div class="coach-recommend" v-show="selected === 'coachHot'">
            <div class="coach-item clearfloat" v-for="itemHost in hotLists">
                <a :href="itemHost.url" class="external">
                    <img :src="itemHost.headimg" class="coach-img"/>
                    <div class="coach-info clearfloat">
                        <span class="title-name">{{itemHost.name}}</span>
                        <img src="__STATIC__/wx/img/ic_gender_man@2x.png" class="coach-sex-img"/>
                        <p class="coach-introduce">{{itemHost.intro}}</p>
                        <div class="coach-label" v-for="name in itemHost.tags_name">
                            <div class="label-item">{{name.name}}</div>
                        </div>
                    </div>
                </a>
            </div>
        </div>
        <!--筛选-->
        <div class="coach-recommend" v-show="selected === 'coachFilter'">
            <div class="coach-item clearfloat" v-for="itemFilter in filterLists">
                <a :href="itemFilter.url" class="external">
                    <img :src="itemFilter.headimg" class="coach-img"/>
                    <div class="coach-info clearfloat">
                        <span class="title-name">{{itemFilter.name}}</span>
                        <img src="__STATIC__/wx/img/ic_gender_man@2x.png" class="coach-sex-img"/>
                        <p class="coach-introduce">{{itemFilter.intro}}</p>
                        <div class="coach-label" v-for="name in itemFilter.tags_name">
                            <div class="label-item">{{name.name}}</div>
                        </div>
                    </div>

                </a>
            </div>
        </div>
    </div>
    <!--底部导航栏-->
    <div class="toolbar tabbar tabbar-labels">
        <div class="toolbar-inner">
            <a href="{:url('stadium/index')}" class="tab-link "> <i
                    class="icon tabbar-demo-icon-3"></i><span
                    class="tabbar-label">场馆</span></a>
            <a href="{:url('coach/index')}" class="tab-link active"><i
                    class="icon tabbar-demo-icon-2"></i><span
                    class="tabbar-label active">教练</span></a>
            <a href="{:url('course/index')}" class="tab-link"> <i
                    class="icon tabbar-demo-icon-1"></i><span
                    class="tabbar-label">课程</span></a>
            <a href="{:url('member/index')}" class="tab-link "> <i
                    class="icon tabbar-demo-icon-4"></i><span
                    class="tabbar-label">我的</span></a>
        </div>
    </div>
    <!--选择栏弹出框-->
    <div class="select-model" v-if="showSelected "@click.stop="showSelected=false">
        <div class="select-content" @click.stop="showSelected=true">
            <div class="lesson-tabbar select-bar">
                <div class="tabbar-item select-item" @click="onSelect('coachRecommend')" @click.stop="showSelected=false">
                    <img src="__STATIC__/wx/img/btn_recommend_nor@2x.png" alt=""/>
                    <div class="tabbar-text">推荐</div>
                </div>
                <div class="tabbar-item select-item" @click="onSelect('coachHot')" @click.stop="showSelected=false">
                    <img src="__STATIC__/wx/img/btn_Popularity_nor@2x.png" alt=""/>
                    <div class="tabbar-text">人气</div>
                </div>
                <div class="tabbar-item select-item" @click="onSelect('coachFilter')">
                    <img src="__STATIC__/wx/img/btn_filter_sel@2x.png" alt=""/>
                    <div class="tabbar-text tabbartext-filter tabbartext-select">筛选</div>
                </div>
            </div>

            <div class="select-box ">
                <div class="clearfloat">
                    <p class="title-name">类型</p>
                    <div class="select-label">
                        <div class="category-all" @click="onCategoryAll">全部</div>
                        <div v-for="(itemCategory,indexCategory ) in category">
                            <div class="label-item category-item"
                                 @click="onCategoryLabel(indexCategory,itemCategory.id)">
                                {{itemCategory.title}}
                            </div>
                        </div>
                    </div>
                </div>
                <div class="select-address clearfloat">
                    <p class="title-name title-address">位置</p>
                    <div class="select-label">
                        <div class="area-all" @click="onAreaAll">全部</div>
                        <div v-for="(itemArea,indexArea) in area">
                            <div class="label-item area-item" @click="onAreaLabel(indexArea,itemArea.district_code)">
                                {{itemArea.district_name}}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="select-work clearfloat">
                    <p class="title-name title-address">从业经验</p>
                    <div class="select-label">
                        <div class="exper-all" @click="onExperAll">全部</div>
                        <div v-for="(itemExper,indexExper) in exper">
                            <div class="label-item exper-item" @click="onExperLabel(indexExper,itemExper.id)">
                                {{itemExper.name}}
                            </div>
                        </div>
                    </div>
                </div>
                <div class="selectBtn">
                    <p class="selectCancel" @click.stop="showSelected=false">取消</p>
                    <p class="selectInsure" @click.stop="onSelectInsure">确定</p>
                </div>
            </div>
        </div>
    </div>
</div>
{/block}

{block name="script"}
<script type="text/javascript">
    sessionStorage.removeItem("need-refresh");
    var arr1 = [];//筛选类型
    var arr2 = [];//筛选区域
    var arr3 = [];//筛选就业经验
    new Vue({
        el: '#app',
        data() {
            return {
                selected: 'coachRecommend',
                coachMan: false,
                coachGril: false,
                showBeVip: false,
                showPhone: false,
                showSex: false,
                showInfo: false,
                showSelected: false,
                isLabel: false,
                banners: [],
                coachLists: [],
                hotLists: [],
                filterLists: [],
                category: [],
                area: [],
                exper: [],
                page: 1,
                responseLength: ''
            }
        },
        mounted: function () {
            var that = this;
            that.$nextTick(function () {
                var myApp = new Framework7();
                var $$ = Dom7;
                this.getCoachList();
                this.getBanner();
                setTimeout(" var myApp = new Framework7();var mySwiper = myApp.swiper('.swiper-stadium', {pagination: '.swiper-stadium .swiper-pagination',speed: 400,spaceBetween: 100});", 500);
                var loading = false;
                // Attach 'infinite' event handler
                $$('.infinite-scroll').on('infinite', function () {
                    if (loading) return;
                    loading = true;
                    // Emulate 1s loading
                    setTimeout(function () {
                        loading = false;
                        if (that.responseLength >= 5) {
                            if (that.selected === 'coachRecommend') {
                                that.getCoachList();
                            }
                            if (that.selected === 'coachHot') {
                                that.getHotList();
                            }
                            if (that.selected === 'coachFilter') {
                                that.getFilterList();
                            }
                        }

                    }, 1000);
                });
            });
        },
        methods: {
            /*轮播*/
            getBanner: function () {
                const that = this;
                axios.post(path + 'index/get_banner_list/type/2')
                    .then(function (response) {
                        that.banners = response.data.data;
                        console.log(that.banners);
                    })
                    .catch(function (error) {
                        console.log(error);
                    });
            },
            /*推荐*/
            getCoachList: function () {
                const that = this;
                axios.post(path + 'coach/get_coach_list', {
                    'type': 'tuijian',
                    'page': that.page,
                }).then(function (response) {
                    that.responseLength = response.data.data.data.length;
                    if (response.data.data.page == 1) {
                        that.coachLists = response.data.data.data;
                        that.page = JSON.parse(response.data.data.page) + 1;
                    } else {
                        if (that.responseLength >= 5) {
                            that.page = JSON.parse(response.data.data.page) + 1;
                        }
                        that.coachLists = that.coachLists.concat(response.data.data.data);

                    }
                    that.coachLists.forEach(function (item) {
                        item.url = "{:url('coach/details')}" + "?id=" + item.id;
                        console.log(1, item.sex);
                        if (item.sex == 1) {
                            that.gender = item.coachMan
                        }
                        if (item.sex == 2) {
                            that.gender = item.coachWomen;
                        }
                    });

                    console.log('coachLists', that.coachLists);
                })
                    .catch(function (error) {
                        console.log(error);
                    });
            },
            /*人气*/
            getHotList: function () {
                const that = this;
                axios.post(path + 'coach/get_coach_list', {
                    'type': 'renqi',
                    'page': that.page
                }).then(function (response) {
                    that.responseLength = response.data.data.data.length;
                    if (response.data.data.page == 1) {
                        that.hotLists = response.data.data.data;
                        that.page = JSON.parse(response.data.data.page) + 1;
                    } else {
                        if (that.responseLength >= 5) {
                            that.page = JSON.parse(response.data.data.page) + 1;
                        }
                        that.hotLists = that.hotLists.concat(response.data.data.data);

                    }
                    that.hotLists.forEach(function (item) {
                        item.url = "{:url('coach/details')}" + "?id=" + item.id;
                    });
                    console.log('hotLists', that.hotLists);
                })
                    .catch(function (error) {
                        console.log(error);
                    });
            },
            /*筛选类型*/
            getFilterList: function (arr1, arr2, arr3) {
                const that = this;
                axios.post(path + 'coach/get_coach_list', {
                    'type': 'screen',
                    'page': that.page,
                    'where': {
                        'type': arr1,
                        'area': arr2,
                        'exper': arr3
                    }
                }).then(function (response) {
                    that.responseLength = response.data.data.data.length;
                    if (response.data.errcode == 500) {
                        myApp.modal({
                            text: '无筛选的结果',
                            buttons: [
                                {
                                    text: '确定'
                                }
                            ]
                        });
                    } else {
                        if (response.data.data.page == 1) {
                            that.filterLists = response.data.data.data;
                            that.page = JSON.parse(response.data.data.page) + 1;
                        } else {
                            if (that.responseLength >= 5) {
                                that.page = JSON.parse(response.data.data.page) + 1;
                            }
                            that.filterLists = that.filterLists.concat(response.data.data.data);
                        }

//                        that.showSelected = false;
                    }
                    that.filterLists.forEach(function (item) {
                        item.url = "{:url('coach/details')}" + "?id=" + item.id;
                    });
                    console.log(response.data);
                })
                    .catch(function (error) {
                        console.log(error);
                    });
            },

            onSelectModel: function () {
                const that = this;
                that.showSelected = !that.showSelected;
                axios.post(path + '/index/get_course_type')
                    .then(function (response) {
                        that.category = response.data.data;
                        console.log('category', response.data);
                    });
                axios.post(path + 'index/get_area_type')
                    .then(function (response) {
                        that.area = response.data.data;
                        console.log("area", that.area);
                    });
                axios.post(path + 'index/get_exper_type')
                    .then(function (response) {
                        that.exper = response.data.data;
                        console.log("exper", that.exper);
                    });
                if (!that.showSelected) {
                    that.getFilterList(arr1, arr2, arr3);
                }

            },

            /*选择切换*/
            onSelect: function (selected) {
                const that = this;
                that.selected = selected;
                if (selected === 'coachRecommend') {
                    that.page = 1;
                    that.getCoachList();
                    $(' .active .item-recommend-img').attr("src", "__STATIC__/wx/img/btn_recommend_sel@2x.png");
                    $(' .item-hot-img').attr("src", "__STATIC__/wx/img/btn_Popularity_nor@2x.png");
                    $('.item-filter-img').attr("src", "__STATIC__/wx/img/btn_filter_nor@2x.png");
                    $('.tabbar-text').removeClass('tabbartext-select');
                    $('.tabbartext-recommend').addClass('tabbartext-select');
                    that.showSelected = false;
                }
                if (selected === 'coachHot') {
                    that.page = 1;
                    that.getHotList();
                    $(' .active .item-hot-img').attr("src", "__STATIC__/wx/img/btn_Popularity_sel@2x.png");
                    $('.item-recommend-img').attr("src", "__STATIC__/wx/img/btn_recommend_nor@2x.png");
                    $('.item-filter-img').attr("src", "__STATIC__/wx/img/btn_filter_nor@2x.png");
                    $('.tabbar-text').removeClass('tabbartext-select');
                    $('.tabbartext-hot').addClass('tabbartext-select');
                    that.showSelected = false;
                }
                if (selected === 'coachFilter') {
                    that.page = 1;
                    that.onSelectModel();
                    that.showSelected=true;
                    that.getFilterList();
                    $(' .active .item-filter-img').attr("src", "__STATIC__/wx/img/btn_filter_sel@2x.png");
                    $('.item-recommend-img').attr("src", "__STATIC__/wx/img/btn_recommend_nor@2x.png");
                    $(' .item-hot-img').attr("src", "__STATIC__/wx/img/btn_Popularity_nor@2x.png");
                    $('.tabbar-text').removeClass('tabbartext-select');
                    $('.tabbartext-filter').addClass('tabbartext-select');
                    console.log('filter');

                }
            },
            /*筛选类型全部*/
            onCategoryAll:function () {
                arr1=[];
                arr2=[];
                arr3=[];
                $('.category-item').removeClass('active');
                $('.category-all').toggleClass('active');
            },
            /*筛选区域全部*/
            onAreaAll:function(){
                arr1=[];
                arr2=[];
                arr3=[];
                $('.area-item').removeClass('active');
                $('.area-all').toggleClass('active');
            },
            /*筛选经验全部*/
            onExperAll:function(){
                arr1=[];
                arr2=[];
                arr3=[];
                $('.exper-item').removeClass('active');
                $('.exper-all').toggleClass('active');
            },
            /*选择类型*/
            onCategoryLabel: function (i, id) {
                $('.category-item').eq(i).toggleClass('active');
                var itemId;
                /*数组去重*/
                for (var x = 0; x < arr1.length; x++) {
                    if (arr1[x] == id) {
                        itemId = x;
                    }
                }
                if (arr1.indexOf(id) !== -1) {
                    arr1.splice(itemId, 1);
                } else {
                    arr1.push(id);
                }
                console.log('itemId', itemId);
                console.log('arr1', arr1);
                if($('.category-item').hasClass('active')){
                    $('.category-all').removeClass('active');
                }
            },
            /*选择区域*/
            onAreaLabel: function (i, id) {
                $('.area-item').eq(i).toggleClass('active');
                var itemId;
                /*数组去重*/
                for (var x = 0; x < arr2.length; x++) {
                    if (arr2[x] == id) {
                        itemId = x;
                    }
                }
                if (arr2.indexOf(id) !== -1) {
                    arr2.splice(itemId, 1);
                } else {
                    arr2.push(id);
                }
                console.log('itemId', itemId);
                console.log('arr2', arr2);
                if($('.area-item').hasClass('active')){
                    $('.area-all').removeClass('active');
                }
            },
            /*选择经验*/
            onExperLabel: function (i, id) {
                $('.exper-item').eq(i).toggleClass('active');
                var itemId;
                /*数组去重*/
                for (var x = 0; x < arr3.length; x++) {
                    if (arr3[x] == id) {
                        itemId = x;
                    }
                }
                if (arr3.indexOf(id) !== -1) {
                    arr3.splice(itemId, 1);
                } else {
                    arr3.push(id);
                }
                console.log('itemId', itemId);
                console.log('arr3', arr3);
                if($('.exper-item').hasClass('active')){
                    $('.exper-all').removeClass('active');
                }
            },
            /*确定筛选*/
            onSelectInsure: function () {
                this.page=1;
                this.getFilterList(arr1, arr2, arr3);
                this.showSelected = false;
            }
        }
    })
</script>
{/block}