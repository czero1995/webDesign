{extend name="layout/base"}

{block name="title"}
<title>场馆列表</title>
{/block}

{block name="style"}
<style type="text/css">
	.top-text{
		padding: 0.24rem 0.3rem;
	    background: #fff;
	    border-top: 1px solid #ccc;
	    position: relative;
	    height: 100%;
	}
	.text-title{
		font-size: 0.28rem;
	    color: #000;
	    font-weight: bold;
	    margin-right: 0.2rem;
	}
	.text-lesson{
		font-size: 0.22rem;
    	color: #000;
	}
	.text-address{
		font-size: 0.24rem;
    	padding-top: 0.08rem!important;
	}
	.text-address img{
		width: 0.16rem;
		height: 0.22rem;
	    margin-right: 12px;
	    vertical-align: middle;
	}
	.order{
		position: absolute;
		 height: 0.56rem;
		  width: 1.1rem;
		  line-height: 0.56rem;
		  text-align: center;
		  border: 1px solid #989898;
		  border-radius: 1rem;
		  font-size: 0.24rem;
		  color: #000;
		  top: 0;
		  bottom: 0;
		  margin: auto;
		  right: 0.3rem;
	}
</style>
{/block}

{block name="content"}
<div class="page stadium-page">
    <div class="page-content infinite-scroll">
        <!--轮播-->
        <div class="swiper-container swiper-stadium">
            <div class="swiper-wrapper">
                <div class="swiper-slide" v-for="banner in banners">
                    <img :src="banner.post"/></div>
            </div>
            <div class="swiper-pagination"></div>
        </div>
        <!--选择栏-->
        <div class="lesson-tabbar">
            <div class="tabbar-item" @click="onSelect('stadiumRecommend')">
                <img src="__STATIC__/wx/img/btn_recommend_sel@2x.png" class="item-recommend-img"
                     v-bind:class="{ active: selected === 'stadiumRecommend'}"/>
                <img src="__STATIC__/wx/img/btn_recommend_nor@2x.png" v-show="selected === '!stadiumRecommend'"/>
                <div class="tabbar-text tabbartext-select tabbartext-recommend">推荐</div>
            </div>
            <div class="tabbar-item" @click="onSelect('stadiumHot')">
                <img src="__STATIC__/wx/img/btn_Popularity_nor@2x.png" class="item-hot-img"
                     v-bind:class="{ active: selected === 'stadiumHot'}"/>
                <div class="tabbar-text tabbartext-hot">人气</div>
            </div>
            <div class="tabbar-item" @click="onSelect('stadiumFilter')">
                <img src="__STATIC__/wx/img/btn_filter_nor@2x.png" class="item-filter-img"
                     v-bind:class="{ active: selected === 'stadiumFilter'}"/>
                <div class="tabbar-text tabbartext-filter">筛选</div>
            </div>
        </div>
        <!--推荐-->
        <div class="stadium-box" v-show="selected === 'stadiumRecommend'">
            <div class="stadium-item" v-for="stadiumList in stadiumLists">
                <a :href="stadiumList.url" class="external">
                    <div class="stadium-top">
                        <img :src="stadiumList.post" class="top-img"/>
                        <img src="__STATIC__/wx/img/triggle.png" class="tirggle-img">
                    </div>
                </a>

                <div class="stadium-bottom clearfloat">
                    <div class="bottom-box">
                        <div class="bottom-item" v-for="course in stadiumList.imgs">
                            <a :href="stadiumList.url" class="external">
                                <img :src="course"/>
                            </a>
                        </div>

                    </div>
                </div>
                
                 <div class="top-text">
                    <span class="text-title">{{stadiumList.title}}</span>
                    <span class="text-lesson">{{stadiumList.count_course}}节课</span>
                    <p class="text-address"><img src="__STATIC__/wx/img/ic_position_nor@2x.png"/>{{stadiumList.address}}
                    </p>
                     <a :href="stadiumList.booking_url" class="external"><span class="order">预定</span></a>
                 </div>

            </div>

        </div>
        <!--人气-->
        <div class="stadium-box" v-show="selected === 'stadiumHot'">
            <div class="stadium-item" v-for="hotList in hotLists">
                <a :href="hotList.url" class="external">
                    <div class="stadium-top">
                        <img :src="hotList.post" class="top-img"/>           
                        <img src="__STATIC__/wx/img/triggle.png" class="tirggle-img">
                    </div>
                </a>
                <div class="stadium-bottom clearfloat">
                    <div class="bottom-box">
                        <div class="bottom-item" v-for="course in hotList.imgs">
                            <a :href="hotList.url" class="external">
                                <img :src="course"/>
                            </a>
                        </div>

                    </div>
                </div>				
				<div class="top-text">
                    <span class="text-title">{{hotList.title}}</span>
                    <span class="text-lesson">{{hotList.count_course}}节课</span>
                    <p class="text-address"><img src="__STATIC__/wx/img/ic_position_nor@2x.png"/>{{hotList.address}}
                    </p>
                     <a :href="hotList.booking_url" class="external"><span class="order">预定</span></a>
                 </div>
            </div>

        </div>
        <!--筛选-->
        <div class="stadium-box" v-show="selected === 'stadiumFilter'">
            <div class="stadium-item" v-for="filterList in filterLists">
                <a :href="filterList.url" class="external">
                    <div class="stadium-top">
                        <img :src="filterList.post" class="top-img"/>                  
                        <img src="__STATIC__/wx/img/triggle.png" class="tirggle-img">
                    </div>
                </a>
                <div class="stadium-bottom clearfloat">
                    <div class="bottom-box">
                        <div class="bottom-item" v-for="course in filterList.imgs">
                            <a :href="filterList .url" class="external">
                                <img :src="course"/>
                            </a>
                        </div>

                    </div>
                </div>
				<div class="top-text">
                    <span class="text-title">{{filterList.title}}</span>
                    <span class="text-lesson">{{filterList.count_course}}节课</span>
                    <p class="text-address"><img src="__STATIC__/wx/img/ic_position_nor@2x.png"/>{{filterList.address}}
                    </p>
                     <a :href="filterList.booking_url" class="external"><span class="order">预定</span></a>
                 </div>
            </div>

        </div>
    </div>
    <!--底部导航栏-->
    <div class="toolbar tabbar tabbar-labels">
        <div class="toolbar-inner">
            <a href="{:url('stadium/index')}" class="tab-link active"> <i
                    class="icon tabbar-demo-icon-3"></i><span
                    class="tabbar-label active">场馆</span></a>
            <a href="{:url('coach/index')}" class="tab-link"><i
                    class="icon tabbar-demo-icon-2"></i><span
                    class="tabbar-label">教练</span></a>
            <a href="{:url('course/index')}" class="tab-link"> <i
                    class="icon tabbar-demo-icon-1"></i><span
                    class="tabbar-label">课程</span></a>
            <a href="{:url('member/index')}" class="tab-link "> <i
                    class="icon tabbar-demo-icon-4"></i><span
                    class="tabbar-label ">我的</span></a>
        </div>
    </div>
    <!--选择栏弹出框-->
    <div class="select-model" v-if="showSelected" @click.stop="showSelected=false">
        <div class="select-content" @click.stop="showSelected=true">
            <div class="lesson-tabbar select-bar">
                <div class="tabbar-item select-item" @click="onSelect('stadiumRecommend')" @click.stop="showSelected=false">
                    <img src="__STATIC__/wx/img/btn_recommend_nor@2x.png" alt=""/>
                    <div class="tabbar-text">推荐</div>
                </div>
                <div class="tabbar-item select-item" @click="onSelect('stadiumHot')" @click.stop="showSelected=false">
                    <img src="__STATIC__/wx/img/btn_Popularity_nor@2x.png" alt=""/>
                    <div class="tabbar-text">人气</div>
                </div>
                <div class="tabbar-item select-item" @click="onSelect('stadiumFilter')">
                    <img src="__STATIC__/wx/img/btn_filter_sel@2x.png" alt=""/>
                    <div class="tabbar-text tabbartext-filter tabbartext-select">筛选</div>
                </div>
            </div>

            <div class="select-box ">
                <div class="clearfloat">
                    <p class="title-name">类型</p>
                    <div class="select-label" >
                        <div class="category-all" @click="onCategoryAll">全部</div>
                        <div v-for="(itemCategory,indexCategory ) in category">
                            <div class="label-item category-item" @click="onCategoryLabel(indexCategory,itemCategory.id)">
                                {{itemCategory.title}}
                            </div>
                        </div>
                    </div>
                </div>
                <div class="select-address clearfloat">
                    <p class="title-name title-address">位置</p>
                    <div class="select-label" >
                        <div class="area-all" @click="onAreaAll">全部</div>
                        <div v-for="(itemArea,indexArea) in area">
                            <div class="label-item area-item" @click="onAreaLabel(indexArea,itemArea.district_code)">
                                {{itemArea.district_name}}
                            </div>
                        </div>
                    </div>
                </div>
                <div class="selectBtn">
                    <p class="selectCancel" @click.stop="showSelected=false">取消</p>
                    <p class="selectInsure" @click.stop="onSelectInsure">确定</p>
                </div>
            </div>
        </div>
    </div>


</div>
{/block}

{block name="script"}
<script type="text/javascript">
    sessionStorage.removeItem("need-refresh");
    var arr1 = []; //筛选类型
    var arr2 = []; //筛选区域
    new Vue({
        el: '#app',
        data() {
            return {
                selected: 'stadiumRecommend',
                showSelected: false,
                isLabel: false,
                stadiumLists: [],
                hotLists: [],
                filterLists: [],
                banners: [],
                category: [],
                area: [],
                page: 1,
                responseLength: ''
            }
        },
        mounted: function () {
            var that = this;
            that.$nextTick(function () {
                var myApp = new Framework7();
                var $$ = Dom7;
                setTimeout(" var myApp = new Framework7();var mySwiper = myApp.swiper('.swiper-stadium', {pagination: '.swiper-stadium .swiper-pagination',speed: 400,spaceBetween: 100});", 500)
                this.getStadiumList();
                this.getBanner();
                var loading = false;
                // Attach 'infinite' event handler
                $$('.infinite-scroll').on('infinite', function () {
                    if (loading) return;
                    loading = true;
                    // Emulate 1s loading
                    setTimeout(function () {
                        loading = false;
                        if (that.responseLength >= 5) {
                            if (that.selected === 'stadiumRecommend') {
                                that.getStadiumList()
                            }
                            if (that.selected === 'stadiumHot') {
                                that.getHotList();
                            }
                            if (that.selected === 'stadiumFilter') {
                                that.getFilterList();
                            }
                        }
                    }, 1000);
                });
            });

        },
        methods: {
            /*轮播*/
            getBanner: function () {
                const that = this;
                axios.post(path + 'index/get_banner_list/type/1')
                    .then(function (response) {
                        that.banners = response.data.data;
                        console.log(that.banners);
                    })
                    .catch(function (error) {
                        console.log(error);
                    });
            },
            /*推荐*/
            getStadiumList: function () {
                const that = this;
                axios.post(path + 'stadium/get_stadium_list', {
                    'type': 'tuijian',
                    'page': that.page
                }).then(function (response) {
                    that.responseLength = response.data.data.data.length;
                    if (response.data.data.page == 1) {
                        that.stadiumLists = response.data.data.data;
                        that.page = JSON.parse(response.data.data.page) + 1;
                    } else {
                        if (that.responseLength >= 5) {
                            that.page = JSON.parse(response.data.data.page) + 1;
                        }
                        that.stadiumLists = that.stadiumLists.concat(response.data.data.data);

                    }
                    that.stadiumLists.forEach(function (item) {
                        item.url = "{:url('stadium/details')}" + "?id=" + item.id;
                        item.course_info.forEach(function (itemcourse) {
                            itemcourse.courseurl = "{:url('course/details')}" + "?id=" + itemcourse.id;
                            console.log(1, itemcourse.courseurl)
                        })
                        console.log(1, item.course_info);
                    });
//                        that.stadiumLists.course_info.forEach(function (item) {
//                            item.courseurl = "{:url('stadium/details')}" + "?id=" + item.id;
//                            console.log(item);
//                        })
                    console.log(that.stadiumLists);
                })
                    .catch(function (error) {
                        console.log(error);
                    });
            },
            /*人气*/
            getHotList: function () {
                const that = this;
                axios.post(path + 'stadium/get_stadium_list', {
                    'type': 'renqi',
                    'page': that.page
                }).then(function (response) {
                    console.log(response.data.data.data.length);
                    that.responseLength = response.data.data.data.length;
                    if (response.data.data.page == 1) {
                        that.hotLists = response.data.data.data;
                        that.page = JSON.parse(response.data.data.page) + 1;
                    } else {
                        if (that.responseLength >= 5) {
                            that.page = JSON.parse(response.data.data.page) + 1;
                        }
                        that.hotLists = that.hotLists.concat(response.data.data.data);

                    }

                    that.hotLists.forEach(function (item) {
                        item.url = "{:url('stadium/details')}" + "?id=" + item.id;
                        item.course_info.forEach(function (itemcourse) {
                            itemcourse.courseurl = "{:url('course/details')}" + "?id=" + itemcourse.id;
                            console.log(1, itemcourse.courseurl)
                        })
                    });
                    console.log('hostList', that.hotLists);
                });
            },
            /*筛选类型*/
            getFilterList: function (arr1, arr2) {
                const that = this;
                axios.post(path + 'stadium/get_stadium_list', {
                    'type': 'screen',
                    'page': that.page,
                    'where': {
                        'type': arr1,
                        'area': arr2
                    }
                }).then(function (response) {
                    that.responseLength = response.data.data.data.length;
                    if (response.data.errcode == 500) {
                        console.log('筛选无结果');
                        myApp.modal({
                            text: '无筛选的结果',
                            buttons: [
                                {
                                    text: '确定'
                                }
                            ]
                        });

                    } else {
                        if (response.data.data.page == 1) {
                            that.filterLists = response.data.data.data;
                            that.page = JSON.parse(response.data.data.page) + 1;
                        } else {
                            if (that.responseLength >= 5) {
                                that.page = JSON.parse(response.data.data.page) + 1;
                            }
                            that.filterLists = that.filterLists.concat(response.data.data.data);

                        }

                        that.filterLists.forEach(function (item) {
                            item.url = "{:url('stadium/details')}" + "?id=" + item.id;
                            item.course_info.forEach(function (itemcourse) {
                                itemcourse.courseurl = "{:url('course/details')}" + "?id=" + itemcourse.id;
                                console.log(1, itemcourse.courseurl)
                            })
                        });
//                        that.showSelected = true;
                    }

                    console.log('filterLists', that.filterLists);
                });
            },
            /*选择切换*/
            onSelect: function (selected) {
                const that = this;
                that.selected = selected;
                if (selected === 'stadiumRecommend') {
                    that.page = 1;
                    that.getStadiumList();
                    $(' .active .item-recommend-img').attr("src", "__STATIC__/wx/img/btn_recommend_sel@2x.png");
                    $(' .item-hot-img').attr("src", "__STATIC__/wx/img/btn_Popularity_nor@2x.png");
                    $('.item-filter-img').attr("src", "__STATIC__/wx/img/btn_filter_nor@2x.png");
                    $('.tabbar-text').removeClass('tabbartext-select');
                    $('.tabbartext-recommend').addClass('tabbartext-select');
                    that.showSelected = false;
                }
                if (selected === 'stadiumHot') {
                    that.page = 1;
                    that.getHotList();
                    $(' .active .item-hot-img').attr("src", "__STATIC__/wx/img/btn_Popularity_sel@2x.png");
                    $('.item-recommend-img').attr("src", "__STATIC__/wx/img/btn_recommend_nor@2x.png");
                    $('.item-filter-img').attr("src", "__STATIC__/wx/img/btn_filter_nor@2x.png");
                    $('.tabbar-text').removeClass('tabbartext-select');
                    $('.tabbartext-hot').addClass('tabbartext-select');
                    that.showSelected = false;
                }
                if (selected === 'stadiumFilter') {
                    that.page = 1;
                    that.showSelected=true;
                    that.getFilterList();
                    that.onSelectModel();
                    $(' .active .item-filter-img').attr("src", "__STATIC__/wx/img/btn_filter_sel@2x.png");
                    $('.item-recommend-img').attr("src", "__STATIC__/wx/img/btn_recommend_nor@2x.png");
                    $(' .item-hot-img').attr("src", "__STATIC__/wx/img/btn_Popularity_nor@2x.png");
                    $('.tabbar-text').removeClass('tabbartext-select');
                    $('.tabbartext-filter').addClass('tabbartext-select');
                }
            },
            onSelectModel: function () {
                const that = this;
//                that.showSelected = !that.showSelected;
                axios.post(path + '/index/get_course_type')
                    .then(function (response) {
                        that.category = response.data.data;
                        console.log(response.data);
                    });
                axios.post(path + 'index/get_area_type')
                    .then(function (response) {
                        that.area = response.data.data;
                        console.log("area", that.area);
                    });

            },
            /*筛选类型全部*/
            onCategoryAll:function () {
                arr1=[];
                arr2=[];
                $('.category-item').removeClass('active');
                $('.category-all').toggleClass('active');
            },
            /*筛选区域全部*/
            onAreaAll:function(){
                arr1=[];
                arr2=[];
                $('.area-item').removeClass('active');
                $('.area-all').toggleClass('active');
            },
            /*筛选类型*/
            onCategoryLabel: function (i, id) {
                $('.category-item').eq(i).toggleClass('active');
                var itemId;
                /*数组去重*/
                for (var x = 0; x < arr1.length; x++) {
                    if (arr1[x] == id) {
                        itemId = x;
                    }
                }

                if (arr1.indexOf(id) !== -1) {
                    arr1.splice(itemId, 1);
                } else {
                    arr1.push(id);
                }
                console.log('arr1', arr1);
                if($('.category-item').hasClass('active')){
                    $('.category-all').removeClass('active');
                }
            },
            /*筛选区域*/
            onAreaLabel: function (i, id) {
                $('.area-item').eq(i).toggleClass('active');
                var itemId;
                /*数组去重*/
                for (var x = 0; x < arr2.length; x++) {
                    if (arr2[x] == id) {
                        itemId = x;
                    }
                }

                if (arr2.indexOf(id) !== -1) {
                    arr2.splice(itemId, 1);
                } else {
                    arr2.push(id);
                }
                console.log('arr2', arr2);
                if($('.area-item').hasClass('active')){
                    $('.area-all').removeClass('active');
                }
            },
            /*确定筛选*/
            onSelectInsure: function () {
                this.page=1;
                this.getFilterList(arr1, arr2);
                this.showSelected=false
            }

        }
    })
</script>
{/block}