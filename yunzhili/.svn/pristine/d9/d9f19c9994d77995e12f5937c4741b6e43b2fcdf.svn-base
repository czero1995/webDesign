<?php 

import('getui.IGt', EXTEND_PATH, '.Push.php');
//import('getui.igetui.IGt',EXTEND_PATH,'.AppMessage.php');
//import('getui.igetui.IGt',EXTEND_PATH,'.APNPayload.php');
//import('getui.igetui.template.IGt',EXTEND_PATH,'.BaseTemplate.php');
//import('getui.IGt',EXTEND_PATH,'.Batch.php');
//import('getui.igetui.utils.AppConditions');

class GeTui {

	private $host; //http://sdk.open.api.igexin.com/apiex.htm';
    
    // private $appid = 'Rop2MFHAso5JYBwKXW2xN3';
    // private $appkey = 'XqkucJqLVN8zRI3QpjInr6';
    // private $mastersecret = 'cApSy13pZ78MpzEhHE98M1';
    // 
    private $appid; // 'zAtFYpuCg86WS88a66vKb2';
    private $appkey; // 'UtdWQiLQi18gYVCBT8Ggk3';
    private $mastersecret; //'jf2sKsSDKX5f9G8SQVIpr1';


    public function __construct($host, $appid, $appkey, $mastersecret)
    {
        $this->host = $host;
        $this->appid = $appid;
        $this->appkey = $appkey;
        $this->mastersecret = $mastersecret;
    }

    /**
     * 推送订单消息
     * @param  [type] $title    [description]
     * @param  [type] $content  [description]
     * @param  [type] $odid     [description]
     * @param  [type] $goods    [description]
     * @param  [type] $num      [description]
     * @param  [type] $contact  [description]
     * @param  [type] $tel      [description]
     * @param  [type] $address  [description]
     * @param  [type] $msgtype  [description]
     * @param  [type] $clientid [description]
     * @return [type]           [description]
     */
    public function pushOrderMsg($title, $content, $odid, $goods, $num, $contact, $tel, $address, $msgtype, $clientid) {

        $igt = new IGeTui($this->host, $this->appkey, $this->mastersecret);
        //此方式可通过获取服务端地址列表判断最快域名后进行消息推送，每10分钟检查一次最快域名
        //消息模版：
        // 1.TransmissionTemplate:透传功能模板
        // 2.LinkTemplate:通知打开链接功能模板
        // 3.NotificationTemplate：通知透传功能模板
        // 4.NotyPopLoadTemplate：通知弹框下载功能模板
        
        $payload = array(
            'odid' => $odid,
            'goods' => $goods,
            'num' => $num,
            'contact' => $contact,
            'tel' => $tel,
            'address' => $address,
            'msgtype' => $msgtype // 消息的类型： 1 = 专属订单推送， 2 = 抢单消息推送
            );

        /// 通知栏消息
        //$res = $this->PushNotificationMsg($title, $content, $payload, $clientid);
        // 透传消息，结合创建本地消息
        $res = $this->pushTransmissionMsg($payload, $clientid);

        $res['clientid'] = $clientid;

        /**
         * 应用离线，则发送离线消息到通知栏
         */
        if(isset($res['result']) && $res['result'] == "ok" && $res['status'] == "successed_offline"){
            //$res = $this->PushNotificationMsg($title, $content, $payload, $clientid);
            //$res['clientid'] = $clientid;
            //$res['type'] = 'notification';
        }

        return $res;
    }


    /**
     * 推送透传消息
     * @param  [type] $payload [description]
     * @return [type]          [description]
     */
    public function pushTransmissionMsg($payload, $clientid)
    {
        $igt = new IGeTui($this->host, $this->appkey, $this->mastersecret);
        //此方式可通过获取服务端地址列表判断最快域名后进行消息推送，每10分钟检查一次最快域名
        //消息模版：
        // 1.TransmissionTemplate:透传功能模板
        // 2.LinkTemplate:通知打开链接功能模板
        // 3.NotificationTemplate：通知透传功能模板
        // 4.NotyPopLoadTemplate：通知弹框下载功能模板
        
        $template =  new \IGtTransmissionTemplate();
        $template->set_appId($this->appid);                   //应用appid
        $template->set_appkey($this->appkey);                 //应用appkey
        $template->set_transmissionType(1);            //透传消息类型
        $template->set_transmissionContent(json_encode($payload));//透传内容

        //个推信息体
        //基于应用消息体
        $message = new \IGtAppMessage();
        $message->set_isOffline(false);
        $message->set_offlineExpireTime(3600*24*1000*7);//离线时间单位为毫秒，例，两个小时离线为3600*1000*2
        $message->set_data($template);
        $message->set_PushNetWorkType(0);//设置是否根据WIFI推送消息，1为wifi推送，0为不限制推送
        $message->set_speed(1000);// 设置群推接口的推送速度，单位为条/秒，例如填写100，则为100条/秒。仅对指定应用群推接口有效。
        $message->set_appIdList(array($this->appid));
        $message->set_phoneTypeList(array('ANDROID'));
//        $message->set_provinceList(array('浙江','上海','北京'));
//        $message->set_tagList(array('开心'));
//        //接收方
        $target = new IGtTarget();
        $target->set_appId($this->appid);
        $target->set_clientId($clientid);

        $res = $igt->pushMessageToSingle($message, $target);

        return $res;
    }



    /**
     * 推送通知栏透传消息
     * @param [type] $msgdata  [description]
     * @param [type] $clientid [description]
     */
    public function PushNotificationMsg($title, $content, $payload, $clientid)
    {
        $igt = new IGeTui($this->host, $this->appkey, $this->mastersecret);
        //此方式可通过获取服务端地址列表判断最快域名后进行消息推送，每10分钟检查一次最快域名
        //消息模版：
        $template =  new \IGtNotificationTemplate();
        $template->set_appId($this->appid);                   //应用appid
        $template->set_appkey($this->appkey);                 //应用appkey
        $template->set_transmissionType(1);            //透传消息类型
        $template->set_transmissionContent(json_encode($payload));//透传内容
        $template->set_title($title);                  //通知栏标题
        $template->set_text($content);     //通知栏内容
        // $template->set_logo("");                       //通知栏logo
        // $template->set_logoURL("");                    //通知栏logo链接
        $template->set_isRing(true);                   //是否响铃
        $template->set_isVibrate(true);                //是否震动
        $template->set_isClearable(true);              //通知栏是否可清除

        //个推信息体
        //基于应用消息体
        $message = new \IGtAppMessage();
        $message->set_isOffline(true);
        $message->set_offlineExpireTime(3600*12*1000);//离线时间单位为毫秒，例，两个小时离线为3600*1000*2
        $message->set_data($template);
        $message->set_PushNetWorkType(0);//设置是否根据WIFI推送消息，1为wifi推送，0为不限制推送
        $message->set_speed(1000);// 设置群推接口的推送速度，单位为条/秒，例如填写100，则为100条/秒。仅对指定应用群推接口有效。
        $message->set_appIdList(array($this->appid));
        $message->set_phoneTypeList(array('ANDROID'));
//        $message->set_provinceList(array('浙江','上海','北京'));
//        $message->set_tagList(array('开心'));
//        //接收方
        $target = new IGtTarget();
        $target->set_appId($this->appid);
        $target->set_clientId($clientid);

        $res = $igt->pushMessageToSingle($message, $target);

        return $res;
    }



    public function pushMessageToSingle()
    {
        $igt = new IGeTui($this->host, $this->appkey, $this->mastersecret);

        $template =  new IGtNotyPopLoadTemplate();
        $template ->set_appId($this->appid);                      //应用appid
        $template ->set_appkey($this->appkey);                    //应用appkey
        //通知栏
        $template ->set_notyTitle("个推");                 //通知栏标题
        $template ->set_notyContent("个推最新版点击下载"); //通知栏内容
        $template ->set_notyIcon("");                      //通知栏logo
        $template ->set_isBelled(true);                    //是否响铃
        $template ->set_isVibrationed(true);               //是否震动
        $template ->set_isCleared(true);                   //通知栏是否可清除
        //弹框
        $template ->set_popTitle("弹框标题");              //弹框标题
        $template ->set_popContent("弹框内容");            //弹框内容
        $template ->set_popImage("");                      //弹框图片
        $template ->set_popButton1("下载");                //左键
        $template ->set_popButton2("取消");                //右键
        //下载
        $template ->set_loadIcon("");                      //弹框图片
        $template ->set_loadTitle("地震速报下载");
        $template ->set_loadUrl("http://dizhensubao.igexin.com/dl/com.ceic.apk");
        $template ->set_isAutoInstall(false);
        $template ->set_isActived(true);

        //设置通知定时展示时间，结束时间与开始时间相差需大于6分钟，消息推送后，客户端将在指定时间差内展示消息（误差6分钟）
        $begin = "2015-02-28 15:26:22";
        $end = "2015-02-28 15:31:24";
        $template->set_duration($begin,$end);


        //定义"SingleMessage"
        $message = new IGtSingleMessage();

        $message->set_isOffline(true);//是否离线
        $message->set_offlineExpireTime(3600*12*1000);//离线时间
        $message->set_data($template);//设置推送消息类型
        //$message->set_PushNetWorkType(0);//设置是否根据WIFI推送消息，2为4G/3G/2G，1为wifi推送，0为不限制推送
        //接收方
        $target = new IGtTarget();
        $target->set_appId($this->appid);
        $target->set_clientId('f89fcd44aed5f8b443a038e0b974d9ec');
    //    $target->set_alias(Alias);

        try {
            $rep = $igt->pushMessageToSingle($message, $target);
            var_dump($rep);
            echo ("<br><br>");

        }catch(RequestException $e){
            $requstId =e.getRequestId();
            //失败时重发
            $rep = $igt->pushMessageToSingle($message, $target,$requstId);
            var_dump($rep);
            echo ("<br><br>");
        }


    }
   
    public function pushToAndroidApp($title, $content, $message) {
        $igt = new IGeTui($this->host, $this->appkey, $this->mastersecret);
        //$igt = new IGeTui('',APPKEY,MASTERSECRET);//此方式可通过获取服务端地址列表判断最快域名后进行消息推送，每10分钟检查一次最快域名
        //消息模版：
        // 1.TransmissionTemplate:透传功能模板
        // 2.LinkTemplate:通知打开链接功能模板
        // 3.NotificationTemplate：通知透传功能模板
        // 4.NotyPopLoadTemplate：通知弹框下载功能模板
            //$template = IGtNotyPopLoadTemplateDemo();
            //$template = IGtLinkTemplateDemo();
//            $template = IGtNotificationTemplateDemo();
            //$template = IGtTransmissionTemplateDemo();
        
        $orderInfo = array(
            'odid' => 10,
            'type' => '送水',
            'num' => '50桶',
            'tel' => '159755942300',
            'address' => '深圳市南山区高新科技园德赛科技大厦'
            );
        
        $template =  new \IGtTransmissionTemplate();
        $template->set_appId($this->appid);                   //应用appid
        $template->set_appkey($this->appkey);                 //应用appkey
        $template->set_transmissionType(1);            //透传消息类型
        $template->set_transmissionContent(json_encode($orderInfo));//透传内容
        //$template->set_title("个推");                  //通知栏标题
        //$template->set_text("个推最新版点击下载");     //通知栏内容
        //$template->set_logo("");                       //通知栏logo
        //$template->set_logoURL("");                    //通知栏logo链接
        //$template->set_isRing(true);                   //是否响铃
        //$template->set_isVibrate(true);                //是否震动
        //$template->set_isClearable(true);              //通知栏是否可清除

        //个推信息体
        //基于应用消息体
        $message = new \IGtAppMessage();
        $message->set_isOffline(true);
        $message->set_offlineExpireTime(3600*12*1000);//离线时间单位为毫秒，例，两个小时离线为3600*1000*2
        $message->set_data($template);
        $message->set_PushNetWorkType(0);//设置是否根据WIFI推送消息，1为wifi推送，0为不限制推送
        $message->set_speed(1000);// 设置群推接口的推送速度，单位为条/秒，例如填写100，则为100条/秒。仅对指定应用群推接口有效。
        $message->set_appIdList(array($this->appid));
        $message->set_phoneTypeList(array('ANDROID'));
//        $message->set_provinceList(array('浙江','上海','北京'));
//        $message->set_tagList(array('开心'));
//        
//        //接收方
        $target = new IGtTarget();
        $target->set_appId($this->appid);
        $target->set_clientId('91ab08aac337120e80c99285e1007a4c');

        $res = $igt->pushMessageToSingle($message, $target);
        return $res;
    }

}



 ?>