<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">

		<title>注册</title>
		<script src="../js/rem.js"></script>
		<link rel="stylesheet" href="../css/base.css">
		<link rel="stylesheet" href="../css/login.css" />
	</head>

	<body>

		<div id="app">
			<div class="header clearfloat" id="topBar">
				<a href="javascript:history.back(-1)">
					<img src="../img/icon/arrowBack.png" />
				</a>
				<p>登录</p>
			</div>
			<div class="container">
				<p class="logo">凡几</p>
				<div class="input-item">
					<input type="text" placeholder="请输入手机号码" v-model="mobile">
				</div>

				<div class="input-item inlinkFlex-spacebetween">
					<input type="text" placeholder="请输入验证码" v-model="yzm">
					<button class="getYZM" @click="onGetYZM()" :disabled="yzmBtn">{{yzmTip}}</button>
				</div>
				<!--<div class="input-item">
					<input type="text" placeholder="请输入密码">
				</div>
				<div class="input-item">
					<input type="text" placeholder="请再次输入密码">
				</div>-->

				<p class="onGo" @click="onGo()">登录</p>
				<div class="inlinkFlex tipBox">
					<!--<a href="login.html" class="external">
						<p class="tip">已有账号?去登录</p>
					</a>-->
				</div>
			</div>
			<!--提示弹窗-->
			<div class="model" v-show="tipModel">
				<div class="model-content tip-content">
					<p>{{tipText}}</p>
					<p @click="tipModel=false">确定</p>
				</div>
			</div>
		</div>
		<script src="../js/axios.js"></script>
		<script src="../js/http.js"></script>
		<script src="../js/vue.js"></script>
		<script>
			var phoneReg = /(1[3-9]\d{9}$)/;
			new Vue({
				el: '#app',
				data() {
					return {
						tipModel: false,
						yzmBtn:false,
						yzmTip:'获取验证码',
						tipText: '',
						yzm: '',
						mobile: '13641418385',
						urls: '',
						memberid:''/*会员id*/
					}
				},
				mounted: function() {
					
				},
				methods: {
                                                             
					/*获取验证码*/
					onGetYZM() {
						const that = this;
						
						console.log('that.mobile', that.mobile)
						if(!phoneReg.test(that.mobile)) {
							that.tipText = '请输入正确手机号码'
							that.tipModel = true;
						} else {
							axios.post(path + 'auth/sendSMSCode', {
									'mobile': that.mobile
								}).then(function(res) {
									if(res.data.data.code == 200){
										var wait = 60;
										time();
										function time() {
		                                    if (wait < 0) {
		                                        that.yzmTip="获取验证码"
		                                        that.yzmBtn=false
		                                        wait = 60;
		                                    } else {
		                                        that.yzmBtn=true;
		                                         that.yzmTip= wait + "秒后获取";
		                                         wait -- ;
		                                        setTimeout(function () {
		                                            time();
		                                        }, 1000)
		                                    }
		                                }
									}
									if(res.data.data.code != 200) {
										that.tipText = '获取验证码失败'
										that.tipModel = true;
									}
									console.log('yzm', res.data.data.code)
								})
								.catch(function(error) {
									console.log(error);
								});
						}

					},
					/*登录*/
					onGo() {
						const that =this;
						if(!phoneReg.test(that.mobile)) {
							that.tipText = '请输入正确手机号码'
							that.tipModel = true
						} else if(that.yzm.length < 6) {
							that.tipText = '请输入正确验证码'
							that.tipModel = true;
						} else {
							axios.post(path + 'auth/verify', {
									'openid': openid,
									'mobile': that.mobile,
									'sms_code': that.yzm
								}).then(function(res) {
									if(res.data.data.code == 200){
										axios.get(path + 'member/buildMember?mobile='+that.mobile, {
											
										}).then(function(res) {
											if(res.data.errcode == 200){
												console.log(res.data.data)
												that.memberid = res.data.data.member.id;
												console.log('that.memberid',that.memberid);
												console.log('openid',openid);
												axios.post(path + 'member/memberRelationOpenid', {
													'member_id': that.memberid,
													'openid' : openid,
													'platform' : 'mp_web'
												}).then(function(res) {
													console.log('linkopen',res)
												})
												.catch(function(error) {
													console.log(error);
												});
//												sessionStorage.member=1;
//												location.href="../index/html";
											}
												console.log('createmember', res)
											})
											.catch(function(error) {
												console.log(error);
											});
									}else{
										that.tipText = '验证码错误';
										that.tipModel = true;
									}
									console.log('go', res)
								})
								.catch(function(error) {
									console.log(error);
								});
						}

					}
				}
			})
		</script>
	</body>

</html>