<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">

		<title>添加收获地址</title>
		<script src="../js/rem.js"></script>
		<link rel="stylesheet" href="../css/base.css">
		<link rel="stylesheet" href="../css/address.css" />
	</head>

	<body>

		<div id="app">

			<div class="container">

				<div class="header clearfloat">
					<div @click="onBack">
						<img src="../img/icon/arrowBack.png" />
					</div>
					<p>收获地址管理</p>
				</div>
				<div class="content">
					<div class="addressItem inlinkFlex" @click="addModel=true">
						<p>所在地区</p>
						<input type="text" placeholder="选择地区" :value="addressaText" readonly=""/>

					</div>
					<div class="addressItem inlinkFlex">
						<p>详细地址</p>
						<input type="text" placeholder="请输入到小区门牌号码" v-model="addressDetail"/>
					</div>
					<div class="addressItem inlinkFlex">
						<p>收货人姓名</p>
						<input type="text" placeholder="收货人姓名" v-model="name"/>
						
					</div>
					<div class="addressItem inlinkFlex">
						<p>手机号码</p>
						<input type="text" placeholder="收货人常用手机号码" v-model="phone"/>
					</div>
					<div class="addressItem inlinkFlex">
						<p>邮政编码</p>
						<input type="text" placeholder="请输入邮政编码" v-model="zipcode"/>
					</div>
					<div class="addressDefault inlinkFlex" @click="onSelectDefault()">
						<img src="../img/icon/radio.png"  v-show="!selectRadio"/>
						<img src="../img/icon/radio_select.png" v-show="selectRadio"/>
						<span>设为默认地址</span>
					</div>
				</div>

				<div class="pageBottom" @click="onInsure">
					<span class="tabbar-label">添加</span>
				</div>
			</div>
			
			<!--地址选择-->
			<div class="model" @click="addModel=false" v-show="addModel">
				<div class="model-address inlinkFlex-spacebetween">
					<!--地区选择-->
					<div class="addressBox">						
						<ul>
							<li v-for="provinceItem in addressList" @click.stop="onProvinceSelect($event,provinceItem.value)">
								<span>{{provinceItem.text}}</span>
								<div class="cityBox">
									<ul>
										<li v-for="cityItem in provinceItem.children"@click.stop="onCitySelect($event,cityItem.value)">
											<span>{{cityItem.text}}</span>
											<div class="areaBox">
												<ul>
													<li v-for="areaItem in cityItem.children"@click.stop="onAreaSelect($event,areaItem.value)">
														<span>{{areaItem.text}}</span>
													</li>
												</ul>
											</div>
										</li>
									</ul>
								</div>
							</li>
						</ul>

					</div>

				</div>
			</div>
			<!--提示成功弹窗-->
			<div class="model" v-show="tipModel">
				<div class="model-content tip-content">
					<p>{{tipText}}</p>
					<p @click="tipModel=false">确定</p>
				</div>
			</div>
		</div>
		<script src="../js/jquery.js"></script>
		<script src="../js/axios.js"></script>
		<script src="../js/http.js"></script>
		<script src="../js/vue.js"></script>
		<script src="../js/data.city.js"></script>
		<script>
			new Vue({
				el: "#app",
				data: {
					addModel: false,
					tipModel:false,
					tipText:'',
					aid:'',
					cartid:'',
					pageurl:'',
					addressList: [], //城市列表
			          province: '', //选中的省份 
			          city: '', //选中的城市
			          area:'', //选择的区域
			          addressaText: '请选择', //选中的完整地址
			          addressDetail:'', //填写的详细地址
			         name:'', //填写的收件人姓名
			         phone:'', //填写的收件人手机号码
			          zipcode:'',//填写的邮政编码
					provinceText:'', /*省编号文字*/
					cityText:'',/*市编号文字*/
					areaText:'',/*区编号文字*/
					selectRadio:false,/*设置默认地址*/
					isDefault: 2,
				
				},
				mounted: function() {
					const that = this;
					that.getUrlParam('id');
					that.getCartParam('cartid');
					that.getPageParam('pageurl')
					 that.addressList = init_city_picker;
				},
				methods: {					
					onInsure: function() {
						const that = this;
						var phoneReg = /(1[3-9]\d{9}$)/;
						if(that.areaText == ''){						
							that.tipText = '请选择地址';
							that.tipModel = true;
						}else if(that.addressDetail.length < 3){						
							that.tipText = '请填写完整详细地址';
							that.tipModel = true;
						}else if(that.name.length<1){							
							that.tipText = '请输入正确姓名';
							that.tipModel = true;
						}else if(!phoneReg.test(that.phone)){							
							that.tipText = '请输入正确手机号码';
							that.tipModel = true;
						}else if(that.zipcode.length<5){							
							that.tipText = '请输入正确邮政编码';
							that.tipModel = true;
						}
						else{
							axios.post(path + 'member_address/addMemberAddress', {
							'consignee':that.name,
							'mobile': that.phone,
							'province':that.provinceText,
							'city':that.cityText,
							'district':that.areaText,
							'address': that.addressDetail,
							'zipcode': that.zipcode,
							'is_default': that.isDefault
							
						}).then(function(res) {
							console.log(res.data.errcode)
							if(res.data.errcode == 200){
								that.onBack();
							}
								console.log('addaddress', res);
							})
							.catch(function(error) {
								console.log(error);
							});			
						}
								
						
					},
					/*返回*/
					onBack(){
						const that = this;
						if(that.aid == 1){
							location.href="address.html?id=" +that.aid;
						}else if(that.aid == 2){
							location.href="address.html?id=" +that.aid + "&&cartid=" +that.cartid +"&&pageurl=" +that.pageurl;
						}
						
					},
					/*获取地址传值*/
					getUrlParam(name) {
						const that = this;
						var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
						var r = window.location.search.substr(1).match(reg);
						if(r != null) {
							that.aid = r[2];
							console.log('that.aid',that.aid)
							return(r[2]);
						}
					},
					/*获取购物车传值*/
					getCartParam(name) {
						const that = this;
						var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
						var r = window.location.search.substr(1).match(reg);
						if(r != null) {
							that.cartid = r[2];
							console.log('that.cartid',that.cartid)
							return(r[2]);
						}
					},
					/*获取页面传值*/
					getPageParam(name) {
						const that = this;
						var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
						var r = window.location.search.substr(1).match(reg);
						if(r != null) {
							that.pageurl = r[2];
							return(r[2]);
						}
					},

					/*设置为默认地址*/
					onSelectDefault(){
						const that = this;
						that.selectRadio = !that.selectRadio;
						if(that.selectRadio == true){
							that.isDefault = 1;
						}else{
							that.isDefault = 2;
						}
						console.log('that.isDefault',that.isDefault);
					},
					onProvinceSelect: function(event,value) {
						var that = this;
						$(event.currentTarget).addClass("active");
						$(event.currentTarget).siblings().removeClass("active");
						that.province = $(event.currentTarget).children("span").text();
						that.provinceText = value +'-' +that.province;
						console.log(that.provinceText)
					},
					onCitySelect: function(event,value) {
						var that = this;
						$(".cityBox").find("li").removeClass("active");
						$(event.currentTarget).addClass("active");
						that.city = $(event.currentTarget).children("span").text();	
						that.cityText = value +'-' +that.city;
					},
					onAreaSelect: function(event,value) {
						var that = this;
						$(".areaBox").find("li").removeClass("select");
						$(event.currentTarget).addClass("select");
						that.area = $(event.currentTarget).children("span").text();
						that.addressaText = that.province + " " + that.city + that.area;
						console.log(that.addressaText);
						that.areaText = value +'-' +that.area;
						that.addModel=false;
					}
				}
			})
		</script>
	</body>

</html>