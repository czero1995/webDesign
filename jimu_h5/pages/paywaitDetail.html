<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
		<title>待支付详情</title>
		<script src="../js/rem.js"></script>
		<link rel="stylesheet" href="../css/base.css">
		<link rel="stylesheet" href="../css/paywaitDetail.css" />
	</head>

	<body>

		<div id="app">

			<div class="container">
				<div class="header clearfloat" id="topBar">
					<div @click="onBack">
						<img src="../img/icon/arrowBack.png" />
					</div>
					<p>订单详情</p>
				</div>
				<a href="address.html" v-show="showAddress">
					<div class="chooseAddress inlinkFlex-spacebetween">
						<div class="inlinkFlex chooseBox">
							<img src="../img/icon/item_address.png" />
							<p>选择送货地址</p>
						</div>
						<img src="../img/icon/arrowRight.png" alt="" />
					</div>
				</a>
				<div @click="onAddress()" v-show="!showAddress">
					<div class="addressBox inlinkFlex">
						<img src="../img/icon/item_address.png" />
						<div class="address-text">
							<div class="inlinkFlex-spacebetween">
								<p class="address-user">收件人:{{addressDetail.consignee}}</p>
								<p class="address-phone">{{addressDetail.mobile}}</p>
							</div>
							<p class="address-location">收获地址:{{addressDetail.province_name}}{{addressDetail.city_name}}{{addressDetail.district_name}}{{addressDetail.address}}</p>
						</div>
					</div>
				</div>
				<div class="orderContent">
					<div class="order-item inlinkFlex" v-for="goodsItem in orderDetail.data">
						<div class="order-image">
							<img :src="goodsItem.goods_thumb" />
						</div>

						<div class="order-textBox">
							<div class="order-text">
								<div class="inlinkFlex">
									<p class="order-name text-ellipsis">{{goodsItem.goods_name}}</p>

								</div>

								<p class="order-coach">¥{{goodsItem.present_price}}</p>
								<p class="order-num">x{{goodsItem.goods_number}}</p>

							</div>

						</div>

					</div>

				</div>
				<div class="pageBottom inlinkFlex-spacebetween">
					<div class="bottom-left">
						<p>商品总金额: <span class="shopCoach">¥ {{orderDetail.total}}</span> </p>
					</div>
					<div class="submitOrder" @click="onSubmitOrder()">提交订单</div>
				</div>
			</div>
		</div>
		<script src="http://res.wx.qq.com/open/js/jweixin-1.2.0.js"></script>
		<script src="../js/axios.js"></script>
		<script src="../js/http.js"></script>
		<script src="../js/vue.js"></script>
		<script>
			new Vue({
				el: '#app',
				data() {
					return {
						orderDetail: {},
						addressDetail:{},
						/*获取订单详情*/
						aid: '',
						/*获取地址传值*/
						showAddress:false,
						addressId:'',
						pageurl:''
					}
				},
				mounted: function() {
					this.getUrlParam('pageurl');
					this.getCartParam('id');
					this.getAddressParam('addressid');
					this.getOrderDetail();
					this.getAddressList();
				},
				methods: {
					/*获取订单详情*/
					getOrderDetail: function() {
						const that = this;
						axios.get(path + 'cart/getCheckedCartById?cart_ids=' + that.aid, {
							
						}).then(function(res) {
								that.orderDetail = res.data.data;
								console.log('orderDetail', that.orderDetail);
							})
							.catch(function(error) {
								console.log(error);
							});
					},
					/*获取地址*/
					getAddressList:function(){
						const that = this;
						axios.get(path + 'member_address/getMemberAddressByDefault?id=' + that.addressId, {
							
						}).then(function(res) {
								that.addressDetail=res.data.data;
								if(that.addressDetail.default == 0 ){
									that.showAddress = true;
								}else{
									that.showAddress = false;
								}
								console.log('addressDetail',that.addressDetail)
							})
							.catch(function(error) {
								console.log(error);
							});
					},
					/*获取页面传值*/
					getUrlParam(name) {
						const that = this;
						var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
						var r = window.location.search.substr(1).match(reg);
						if(r != null) {
							that.pageurl = r[2];
							console.log('that.aid.page',that.aid)						
						}							
							return(r[2]);
					},
					/*获取商品传值*/
					getCartParam(name) {
						const that = this;
						var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
						var r = window.location.search.substr(1).match(reg);
						if(r != null) {
							that.aid = r[2];
							console.log('that.aid',that.aid)						
						}							
							return(r[2]);
					},
					/*获取地址传值*/
					getAddressParam(name) {
						const that = this;
						var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
						var r = window.location.search.substr(1).match(reg);
						if(r != null) {
							that.addressId = r[2];
							console.log('that.addressId',that.addressId);						
							return(r[2]);
						}
					},
					/*提交订单*/
					onSubmitOrder(){
						const that = this;
						axios.post(path + 'order/createOrder', {
							'cart':that.aid,
							'address_id': that.addressDetail.id
						}).then(function(res) {
								if(res.data.errcode == 200){
									that.onPay();
								}
							})
							.catch(function(error) {
								console.log(error);
							});
					},
					/*返回*/
					onBack(){
						const that = this;
						if(that.pageurl == 1){
							location.href='cart.html';
						}else if(that.pageurl == 2){
							location.href="detail.html";
						}
					},
					/*选择地址*/
					onAddress(){
						const that = this;
						location.href="address.html?cartid="+ that.aid + "&&id=2" + "&&pageurl=" +that.pageurl;						
					},
					/*支付*/
					onPay() {
						const that = this;
						axios.get(path + 'pay/wxPay?id=' + that.aid, {

							}).then(function(res) {
								if(res.data.errcode == 200) {
									console.log('res', res.data.data.appId)
									wx.chooseWXPay({
										appId: res.data.data.appId,
									    timestamp: res.data.data.timeStamp, // 支付签名时间戳，注意微信jssdk中的所有使用timestamp字段均为小写。但最新版的支付后台生成签名使用的timeStamp字段名需大写其中的S字符
									    nonceStr: res.data.data.nonceStr, // 支付签名随机串，不长于 32 位
									    package: res.data.data.package, // 统一支付接口返回的prepay_id参数值，提交格式如：prepay_id=***）
									    signType: res.data.data.signType, // 签名方式，默认为'SHA1'，使用新版支付需传入'MD5'
									    paySign: res.data.data.paySign, // 支付签名
									    success: function (res) {
									        // 支付成功后的回调函数
									    }
									});
//									WeixinJSBridge.invoke(
//										'getBrandWCPayRequest', {
//											"appId": res.data.data.appId, //公众号名称，由商户传入     
//											"timeStamp": res.data.data.timeStamp, //时间戳，自1970年以来的秒数     
//											"nonceStr": res.data.data.nonceStr, //随机串     
//											"package": "prepay_id=" + res.data.data.package,
//											"signType": res.data.data.signType, //微信签名方式：     
//											"paySign": res.data.data.paySign //微信签名 
//										},
//										function(res) {
//											alert(JSON.stringify(res));
//											if(res.err_msg == "get_brand_wcpay_request:ok") {
//												alert('ok');
//											} else if(res.err_msg == "get_brand_wcpay_request:cancel") {
//												alert('cancel')
//											} else if(res.err_msg == "get_brand_wcpay_request:fail") {
//												//										alert(res)
//											}
//										}
//									);

								}
								console.log(JSON.stringify(res))
							})
							.catch(function(error) {
								console.log(error)
							});

					}
				}
			})
		</script>
	</body>

</html>