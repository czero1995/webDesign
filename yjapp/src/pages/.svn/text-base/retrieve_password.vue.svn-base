<template>
	<div data-page="retrieve-password" class="page retrieve-password-page">
		<!-- Top Navbar-->
		<div class="navbar">
			<div class="navbar-inner">
				<div class="left" @click="routeBack">
					<a href="javascript:void(0);" class="back icon icon-back"></a>
				</div>
				<div class="center"><span class="text-gradient" v-text="$t('app.page.retrieve_password')">找回密码</span></div>
			</div>
		</div>
		<!-- /End of Top Navbar-->
		<div class="page-content">
			<div class="retrieve-box clearfloat">
				<input type="text" :placeholder="$t('app.retrieve_password.member_id')" class="input-id" v-model="loginId" />
				<div style="position: relative;">
					<input type="text" :placeholder="$t('app.retrieve_password.email')" class="input-mail" v-model="email" />
					<div class="retrieveBtn text-gradient">
						<span class="hr "></span>
						<span @click="sendEmail" v-text="$t('app.retrieve_password.send_email')">发送邮件</span>
					</div>
				</div>
			</div>
			<div class="retrieve-title" v-text="$t('app.retrieve_password.check_email_to_reset_password')">
				请登录邮箱重置密码
			</div>
		</div>
	</div>
</template>

<style lang="less">
	.retrieve-password-page {
		.retrieve-box {
			background: #FFFFFF;
			width: 100%;
			height: 1.76rem;
			line-height: 0.88rem;
			.input-id {
				width: 100%;
				display: block;
				height: 0.88rem;
				line-height: 0.34rem;
				border: none;
				padding-left: 0.3rem;
				border-bottom: 1px solid #CCCCCC;
			}
			.input-mail {
				font-family: PingFangSC-Regular;
				font-size: 0.26rme;
				letter-spacing: 0.76px;
				line-height: 0.34rem;
				padding-left: 0.3rem;
				border: none;
				width: 100%;
				height: 0.88rem;
				display: block;
				border-bottom: 1px solid #CCCCCC;
			}
			.retrieveBtn {
				position: absolute;
				top: 0;
				right: 0;
				width: 2rem;
				height: 0.88rem;
				display: inline-block;
				padding-left: 0.2rem;
				.hr {
					display: inline-block;
					height: 0.4rem;
					background: #E7D9B4;
					width: 1px;
					margin-right: 0.3rem;
					vertical-align: middle;
				}
			}
		}
		.retrieve-title {
			margin-top: 0.4rem;
			text-align: center;
		}
	}
	
	.clearfloat::after {
		display: block;
		content: '';
		height: 0;
		width: 0;
		clear: both
	}
</style>
<script>
	import axios from 'axios'
	import { mapState } from 'vuex'
	export default {
		data() {
			return {
				loginId: '',
				email: ''
			}
		},
		computed: {
			...mapState({
				plusReady: state => state.plusReady,
				user: state => state.user,
				ajax_result: state => state.ajax_result
			})
		},
		mounted() {
			const that = this
			that.$nextTick(_ => {
				if(that.plusReady) {
					// 首先移除事件
					window.plus.key.removeEventListener('backbutton', function() {
						console.log('removeEventListener')
					}, false)
					// Android处理返回键
					window.plus.key.addEventListener('backbutton', function() {
						that.routeBack()
					}, false)
				}
			})
		},
		methods: {
			routeBack: function() {
				const that = this
				// 当前弹出的层
				var modalIn = that.$$('.modal-in')
				console.log('modal_in', modalIn)
				if(modalIn.length === 0) {
					that.$f7.mainView.router.load({
						url: '/login/'
					})
				} else {
					that.$f7.closeModal(modalIn[modalIn.length - 1])
				}
			},
			sendEmail() {
				const that = this
				if(that.loginId.trim().length === 0 || that.email.trim().length === 0) {
					that.$f7.alert(that.$t('app.retrieve_password.memberid_email_required'))
				} else {
					that.$f7.showPreloader(that.$t('app.retrieve_password.loading'))
					axios.post('Member/Account/ForgotPassword', {
						'Email': that.email,
						'LoginId': that.loginId
					}).then(res => {
						console.log('forgetPassword', res)
						that.$f7.hidePreloader()
						if(res.IsSuccess === true) {
							that.$f7.alert(that.$t('app.retrieve_password.success') + ':' + that.$t('app.retrieve_password.check_email_to_reset_password'))
							that.email = ''
							that.loginId = ''
						} else {
							that.$f7.alert(res.ErrorInfos[0].Message)
						}
					})
				}
			}
		},
		components: {}
	}
</script>